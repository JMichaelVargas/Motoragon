<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>ADMIN - Motoragon</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="css/admin.css" rel="stylesheet">
</head>

<body>
    <div class="container-fluid position-relative bg-white d-flex p-0">
        <!-- Spinner Start -->
        <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <!-- Spinner End -->


        <!-- Sidebar Start -->
        <div class="sidebar pe-4 pb-3">
            <nav class="navbar bg-light navbar-light">
                <a href="admin.html" class="navbar-brand mx-4 mb-3">
                    <h3 class="text-primary">MOTORAGON</h3>
                </a>
                <div class="d-flex align-items-center ms-4 mb-4">
                    <div class="position-relative">
                        <img class="rounded-circle" src="img/team/mark.jpg" alt="" style="width: 40px; height: 40px;">
                        <div class="bg-success rounded-circle border border-2 border-white position-absolute end-0 bottom-0 p-1"></div>
                    </div>
                    <div class="ms-3">
                        <h6 class="mb-0">Mark Bitancor</h6>
                        <span>Admin</span>
                    </div>
                </div>
                <div class="navbar-nav w-100">
                    <a href="admin.html" class="nav-item nav-link"><i class="fa fa-tachometer-alt me-2"></i>Dashboard</a>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle active" data-bs-toggle="dropdown"><i class="fas fa-bicycle"></i>Products</a>
                        <div class="dropdown-menu bg-transparent border-0">
                            <a href="add-product.html" class="dropdown-item active">Add Product</a>
                            <a href="show-product.html" class="dropdown-item">Show Products</a>
                        </div>
                    </div>
                    <a href=".html" class="nav-item nav-link"><i class="fa fa-th me-2"></i>Orders</a>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown"><i class="far fa-file-alt me-2"></i>Pages</a>
                        <div class="dropdown-menu bg-transparent border-0">
                            <a href="login.html" class="dropdown-item">Sign In</a>
                            <a href="signup.html" class="dropdown-item">Sign Up</a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
        <!-- Sidebar End -->


        <!-- Content Start -->
        <div class="content">
            <!-- Navbar Start -->
            <nav class="navbar navbar-expand bg-light navbar-light sticky-top px-4 py-0">
                <a href="admin.html" class="navbar-brand d-flex d-lg-none me-4">
                    <h2 class="text-primary mb-0"><i class="fa fa-hashtag"></i></h2>
                </a>
                <a href="#" class="sidebar-toggler flex-shrink-0">
                    <i class="fa fa-bars"></i>
                </a>
                <div class="navbar-nav align-items-center ms-auto">
                    <div class="nav-item dropdown">                  
                    </div>
                    <div class="nav-item dropdown">
                    </div>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                            <img class="rounded-circle me-lg-2" src="img/team/mark.jpg" alt="" style="width: 40px; height: 40px;">
                            <span class="d-none d-lg-inline-flex">Mark Bitancor</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end bg-light border-0 rounded-0 rounded-bottom m-0">
                            <a href="#" class="dropdown-item">My Profile</a>
                            <a href="#" class="dropdown-item">Log Out</a>
                        </div>
                    </div>
                </div>
            </nav>
            <!-- Navbar End -->

            <!-- CRUD START -->
            <div class="adding_section">
                <div class="adding_container">
                    <div class="prod-admin_title"><h1>Add Products</h1></div>
                    <div class="prod_inputs"><label>Product Name</label> <input type="text" id="nameinp"></div>
                    <div class="prod_inputs"><label>Product Price</label> <input type="text" id="priceinp"></div>
                    <div class="prod_inputs"><label>Stock</label> <input type="text" id="stockinp"></div>
                    <div class="prod_inputs">
                        <label>Category</label>
                        <select id="catinp">
                            <option value="New Arrival">New Arrival</option>
                            <option value="Mountain Bikes">Mountain Bikes</option>
                            <option value="Kiddie Bikes">Kiddie Bikes</option>
                        </select>
                    </div>
                    <div class="prod_inputs"><label id="pdlab">Description</label> <textarea id="desarea"></textarea></div>
                    
                    <div class="add_img_container">
                        <div class="img_title">Image</div>
                        <div id="imagesDiv"></div>
                        <div id="controldiv">
                            <button id="addprodbtn">Add Product</button>
                            <button id="selimgsbtn">Select Image</button>
                        </div>
                    </div>
                </div>
                <div class="display_container">
                    <div id="disp-card_container"></div>
                </div>
            </div>

            <!-- CRUD END -->

            <!-- Footer Start -->
            <div class="container-fluid pt-4 px-4">
                <div class="bg-light rounded-top p-4">
                    <div class="row">
                        <div class="col-12 col-sm-6 text-center text-sm-start">
                            &copy; <a href="#">Motoragon</a>, All Right Reserved. 
                        </div>
                        <div class="col-12 col-sm-6 text-center text-sm-end">
                            <!--/*** This template is free as long as you keep the footer author’s credit link/attribution link/backlink. If you'd like to use the template without the footer author’s credit link/attribution link/backlink, you can purchase the Credit Removal License from "https://htmlcodex.com/credit-removal". Thank you for your support. ***/-->
                            Designed By <a href="https://htmlcodex.com">HTML Codex</a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Footer End -->
        </div>
        <!-- Content End -->


        <!-- Back to Top -->
        <!-- <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a> -->
    </div>

    <!-- FIREBASE JS -->
    <script type="module">
        // References
        var Files = [];
        var FileReaders = [];
        var ImagesLinksArray = [];

        const imgdiv = document.getElementById('imagesDiv');
        const selBtn = document.getElementById('selimgsbtn');
        const addBtn = document.getElementById('addprodbtn');
    
        const name = document.getElementById('nameinp');
        const category = document.getElementById('catinp');
        const description = document.getElementById('desarea');
        const price = document.getElementById('priceinp');
        const stock = document.getElementById('stockinp');

        function OpenFileDialog(){
            let inp = document.createElement('input');
            inp.type = 'file';
            inp.multiple = 'multiple';

            inp.onchange = (e) => {
                AssignImgsToFilesArray(e.target.files);
                CreateImgTags();
            }

            inp.click();
            showMenuData();
        }

        function AssignImgsToFilesArray(thefiles){
            let num = Files.length + thefiles.length;
            let looplim = (num <=1) ? thefiles.length : (1-Files.length)

            for (let i = 0; i < looplim; i++) {
                Files.push(thefiles[i]);
            }

            if(num>1) alert("Maximum 1 image are allowed!");
        }

        function CreateImgTags(){
            imgdiv.innerHTML='';
            imgdiv.classList.add('imagesDivStyle');

            for (let i = 0; i < Files.length; i++) {
                FileReaders[i] = new FileReader();

                FileReaders[i].onload = function(){
                    var img = document.createElement('img');
                    img.id = 'imgNo'+ i;
                    img.classList.add('imgs');
                    img.src = FileReaders[i].result;
                    imgdiv.append(img);
                }

                FileReaders[i].readAsDataURL(Files[i]);
            }

            let lab = document.getElementById('label');
            lab.innerHTML = 'Clear Image';
            lab.style = 'cursor:pointer;display:block;color:#fe0007;font-size:12px';
            lab.addEventListener('click', ClearImages);
            imgdiv.append(lab);
        }

        function ClearImages(){
            Files=[];
            ImagesLinksArray=[];
            imgdiv.innerHTML='';
            imgdiv.classList.remove('imagesDivStyle');
        }

        function getShortTitle(){
            let namey = (name && name.value) ? name.value.substring(0, 50) : '';
            return namey.replace(/[^a-zA-Z0-9]/g, '');
            // let namey = name.value.substring(0,50);
            // return namey.replace(/[^a-zA-Z0-9]/g,"");
        }

        function GetImgUploadProgress(){
            return 'Images Uploaded '+ ImagesLinksArray.length + 'of ' + Files.length;
        }

        function IsAllImagesUploaded(){
            return ImagesLinksArray.length == Files.length
        }

        function RestoreBack(){
            selBtn.disabled =false;
            addBtn.disabled =false;
        }

        // Events
        selBtn.addEventListener('click', OpenFileDialog);
        addBtn.addEventListener('click', UploadAllImages);

        //Upload Image to Firebase
        function UploadAllImages(){
            selBtn.disabled =true;
            addBtn.disabled =true;

            ImagesLinksArray=[];

            for (let i = 0; i < Files.length; i++) {
                UploadAnImage(Files[i], i);
            }
        }

        function UploadAnImage(imgToUpload, imgNo){
            const metadata = {
                contentType: imgToUpload.type
            };

            const storage = getStorage();

            const ImageAddress="TheImages/"+ getShortTitle() +"/img#"+ (imgNo+1);

            const storageRef = sRef(storage, ImageAddress);

            const UploadTask = uploadBytesResumable(storageRef, imgToUpload, metadata);

            UploadTask.on('state_changed', (snapshot) =>{
                // proglab.innerHTML = 
                GetImgUploadProgress();
            },

            (error)=>{
                alert("Error: Image Upload Failed");
            },

            ()=>{
                getDownloadURL(UploadTask.snapshot.ref).then((downloadURL) =>{
                    ImagesLinksArray.push(downloadURL);
                    if(IsAllImagesUploaded()){
                        // proglab.innerHTML = "all images uploaded";
                        UploadAProduct();
                    }
                });
            }
            );
        }
        /*
        //Read Data from Database

        // function showProducts(){
        //     const cardContainer = document.getElementById('disp-card_container');
        //     cardContainer,innerHTML = '';

        //     const prodRef = ref(realdb, 'TheProductRealdb/');
        //         onValue(prodRef, (snapshot) => {
        //         const data = snapshot.val();
        //         const dataCard = 

        //         });
        // }

        function createDataCard(key, val){
            const cardContent = document.createElement('div');
            var value = JSON.stringify(val);
            cardContent.className = ('card_content');
            console.log(key +" "+ value);
            if(value.image){
                const image = document.createElement('img');
                img.src = data.image;
                image.style.maxHeight = '221px';
                cardContent.appendChild(image);
            }
            
            const title = document.createElement("h3");
            title.textContent = value.ProductTitle;
            cardContent.appendChild(title);
            
            const prodCategoryInput = createLabelInputPair('Category', createInput('text', '', value.Category));
            const prodDescriptionInput = createLabelInputPair('Description', createInput('text', '', value.Description));
            const prodPriceInput = createLabelInputPair('Price', createInput('number', '', value.Price));
            const prodStockInput = createLabelInputPair('Category', createInput('text', '', value.Stock));

            cardContent.appendChild(prodCategoryInput);
            cardContent.appendChild(prodDescriptionInput);
            cardContent.appendChild(prodPriceInput);
            cardContent.appendChild(prodStockInput);
        }

        function createLabelInput(label, InputElement){
            const pairContainer = document.createElement('div');
            const labelElement = document.createElement('label');
            labelElement.textContent = `${label}: `;
            pairContainer.appendChild(labelElement);
            pairContainer.appendChild(inputElement);
            return pairContainer;
        }

        function showMenuData() {
            const dataContainer = document.getElementById('dataContainer');
            const dbRef = ref(realdb);

            onValue(dbRef, (snapshot) => {
            if (snapshot.exists()) {
                // Iterate over each child node
                snapshot.forEach((childSnapshot) => {
                    const key = childSnapshot.key;
                    const val = childSnapshot.val();
                    const dataCard = createDataCard(key, val);
                    dataContainer.appendChild(dataCard);
                });
            } else {
                console.log("No data available");
            }
            }, (error) => {
            console.error(error);
            });

            // get(child(dbRef, `TheProductRealdb/`+'bike')).then((snapshot) => {
            //     if (snapshot.exists()) {
            //         console.log(snapshot);
                    
            //     } else {
            //         console.log("No data available");
            //     }
            // }).catch((error) => {
            //     console.error(error);
            // });


            // // Use onSnapshot to listen for real-time updates
            // menuCollection.onSnapshot((querySnapshot) => {
            //     querySnapshot.forEach((doc) => {
            //     const dataCard = createDataCard(doc.id, doc.data());
            //     dataContainer.appendChild(dataCard);
            //     });
            // }, (error) => {
            //     console.error('Error getting real-time menu data:', error);
            // });
        }*/

        //Read Data from Database


        //Imports + Configuration

        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDAwlRuUI6XE9yJqh30UFwbfF7dusvkrfg",
            authDomain: "authentication-8a811.firebaseapp.com",
            databaseURL: "https://authentication-8a811-default-rtdb.firebaseio.com",
            projectId: "authentication-8a811",
            storageBucket: "authentication-8a811.appspot.com",
            messagingSenderId: "421435285777",
            appId: "1:421435285777:web:912a5aabaceca6fb54ecb0",
            measurementId: "G-BFJ5J6MW02"
        };

        
        //Import Firebase Storage Functions
        import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        //Firebase Realtime Database
        import { getDatabase, ref, set, child, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        //Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const realdb = getDatabase();

        function clearFormFields() {
        name.value = '';
        price.value = '';
        stock.value = '';
        category.value = 'New Arrival'; // Assuming 'New Arrival' is the default category
        description.value = '';
        ClearImages(); // Clear uploaded images
    }

    // Function to handle successful upload
    function handleUploadSuccess() {
        alert("Upload Successful");
        clearFormFields(); // Call the function to clear form fields
        RestoreBack();
    }


        //Upload a Product
        function UploadAProduct(){
            const productRef = ref(realdb, "TheProductRealdb/" + getShortTitle());

            set(productRef/*ref(realdb, "TheProductRealdb/"+ getShortTitle())*/,{
                ProductTitle: name.value,
                Category: category.value,
                Description: description.value,
                Price: price.value,
                Stock: stock.value,
                LinksOfImagesArray: ImagesLinksArray
            }).then(() => {
            handleUploadSuccess(); // Call the function to handle successful upload
        });
            
            return productRef;
        }

    </script>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/chart/chart.min.js"></script>
    <script src="lib/easing2/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="lib/tempusdominus/js/moment.min.js"></script>
    <script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/admin.js"></script>
</body>

</html>